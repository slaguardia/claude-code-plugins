name: Validate Plugins

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate marketplace.json
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "Error: marketplace.json not found"
            exit 1
          fi
          echo "Validating marketplace.json..."
          cat .claude-plugin/marketplace.json | python3 -m json.tool > /dev/null
          echo "marketplace.json is valid JSON"

      - name: Validate plugin structures
        run: |
          echo "Checking plugin directories..."
          for plugin_dir in plugins/*/; do
            if [ -d "$plugin_dir" ]; then
              plugin_name=$(basename "$plugin_dir")
              echo "Validating plugin: $plugin_name"

              if [ ! -f "${plugin_dir}plugin.json" ]; then
                echo "Error: ${plugin_dir}plugin.json not found"
                exit 1
              fi

              cat "${plugin_dir}plugin.json" | python3 -m json.tool > /dev/null
              echo "  - plugin.json is valid"
            fi
          done
          echo "All plugins validated successfully!"
